name: Deploy to GCP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.GCP_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to GCP
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} << 'ENDSSH'
        # GCP VM에서 실행할 명령어들
        echo "🚀 GCP 자동 배포 시작..."
        
        # 프로젝트 디렉토리로 이동
        cd /home/lung-cancer-app || {
          echo "❌ 프로젝트 디렉토리를 찾을 수 없습니다. 클론을 시도합니다..."
          git clone https://github.com/your-username/your-repo.git /home/lung-cancer-app
          cd /home/lung-cancer-app
        }
        
        # Git 최신 코드 가져오기
        echo "📥 최신 코드 가져오는 중..."
        git pull origin main
        
        # 기존 컨테이너 중지
        echo "🛑 기존 컨테이너 중지 중..."
        docker-compose down || true
        
        # 새 이미지 빌드
        echo "🔨 새 이미지 빌드 중..."
        docker-compose build --no-cache
        
        # 컨테이너 시작
        echo "▶️ 컨테이너 시작 중..."
        docker-compose up -d
        
        # 배포 완료 확인
        echo "✅ 배포 완료!"
        echo "🌐 접속 URL: http://104.154.212.61:8000"
        
        # 컨테이너 상태 확인
        docker-compose ps
        ENDSSH