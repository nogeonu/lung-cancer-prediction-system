name: Deploy to GCP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.GCP_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to GCP
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.GCP_USERNAME }}@${{ secrets.GCP_HOST }} << 'ENDSSH'
        # GCP VMì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤
        echo "ðŸš€ GCP ìžë™ ë°°í¬ ì‹œìž‘..."
        
        # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
        cd /home/lung-cancer-app || {
          echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í´ë¡ ì„ ì‹œë„í•©ë‹ˆë‹¤..."
          git clone https://github.com/your-username/your-repo.git /home/lung-cancer-app
          cd /home/lung-cancer-app
        }
        
        # Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        echo "ðŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
        git pull origin main
        
        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
        echo "ðŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
        docker-compose down || true
        
        # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ
        echo "ðŸ”¨ ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker-compose build --no-cache
        
        # ì»¨í…Œì´ë„ˆ ì‹œìž‘
        echo "â–¶ï¸ ì»¨í…Œì´ë„ˆ ì‹œìž‘ ì¤‘..."
        docker-compose up -d
        
        # ë°°í¬ ì™„ë£Œ í™•ì¸
        echo "âœ… ë°°í¬ ì™„ë£Œ!"
        echo "ðŸŒ ì ‘ì† URL: http://104.154.212.61:8000"
        
        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        docker-compose ps
        ENDSSH