name: ğŸš€ GCP ìë™ ë°°í¬

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ íŠ¸ë¦¬ê±°

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: ğŸ”‘ SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.GCP_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ GCP ì„œë²„ì— ë°°í¬
        env:
          GCP_HOST: ${{ secrets.GCP_HOST }}
          GCP_USERNAME: ${{ secrets.GCP_USERNAME }}
        run: |
          ssh -o StrictHostKeyChecking=no $GCP_USERNAME@$GCP_HOST << 'ENDSSH'
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/lung-cancer-app || {
              echo "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í´ë¡ ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
              cd /home
              git clone https://github.com/nogeonu/lung-cancer-prediction-system.git lung-cancer-app
              cd lung-cancer-app
            }
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin
            git reset --hard origin/main
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker-compose down
            
            # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ
            echo "ğŸ”¨ ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            docker-compose build --no-cache
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "â–¶ï¸ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            docker-compose up -d
            
            # ë°°í¬ ì™„ë£Œ í™•ì¸
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ ì ‘ì† URL: http://104.154.212.61:8000"
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            docker-compose ps
          ENDSSH
      
      - name: âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸŒ ì ‘ì† URL: http://104.154.212.61:8000"
      
      - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "âš ï¸ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
